version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      - PORT=5000  # –£–±–µ–¥–∏—Å—å, —á—Ç–æ Next.js —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —ç—Ç–æ–º –ø–æ—Ä—Ç—É
      - EMAIL_USER=${EMAIL_USER}
      - EMAIL_PASS=${EMAIL_PASS}
    labels:
      - "traefik.enable=true"

      # üîπ HTTPS Router
      - "traefik.http.routers.biz-vokrug-app.rule=Host(`bizvokrug.ru`)"
      - "traefik.http.routers.biz-vokrug-app.entryPoints=websecure"
      - "traefik.http.routers.biz-vokrug-app.tls.certresolver=letsencrypt"
      - "traefik.http.services.biz-vokrug-app-service.loadbalancer.server.port=5000"

      # üîπ HTTP Router –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –Ω–∞ HTTPS
      - "traefik.http.routers.biz-vokrug-app-http.rule=Host(`bizvokrug.ru`)"
      - "traefik.http.routers.biz-vokrug-app-http.entryPoints=web"
      - "traefik.http.routers.biz-vokrug-app-http.middlewares=https-redirect"

      # üîπ Middleware –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –Ω–∞ HTTPS
      - "traefik.http.middlewares.https-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.https-redirect.redirectscheme.permanent=true"

      # üîπ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –†–µ–¥–∏—Ä–µ–∫—Ç www ‚Üí –±–µ–∑ www
      - "traefik.http.routers.www-to-nonwww.rule=Host(`www.bizvokrug.ru`)"
      - "traefik.http.routers.www-to-nonwww.entryPoints=web"
      - "traefik.http.routers.www-to-nonwww.middlewares=redirect-to-root"
      - "traefik.http.middlewares.redirect-to-root.redirectregex.regex=^https?://www.(.*)"
      - "traefik.http.middlewares.redirect-to-root.redirectregex.replacement=https://$1"

    networks:
      - biznes_vokrug_network  # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ç–∏

networks:
  biznes_vokrug_network:
    external: true
